<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Historical Authority Codes | PBS Tools</title>
	<link rel="icon" type="image/x-icon" href="src/favicon.ico">
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.css">
	<script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.js"></script>
</head>

<style>
	.RestrictionIdsList > .label {
		transition: 0.5s !important;
		cursor: pointer;
	}

	.StreamlinedCodesList > .label {
		transition: 0.5s !important;
		cursor: pointer;
	}

	.RestrictionDate {
		transition: 0.5s !important;
		cursor: pointer;
	}

	.AuthorityDate {
		transition: 0.5s !important;
		cursor: pointer;
	}
</style>

<body>

	<div class="ui menu">
		<a class="ui item header" href="index.html">
			<img class="ui mini spaced image" src="src/icon.png">
			<span>PBS Tools</span>
		</a>
		<a class="item" href="ItemCodes.html">Item Codes</a>
		<a class="item" href="CurrentAuthorityCodes.html">Current Authority Codes</a>
		<a class="active item" href="HistoricalAuthorityCodes.html">Historical Authority Codes</a>
		<a class="item" href="DailyDefinedDose.html">Daily Defined Dose</a>
	</div>

	<div class="ui center aligned container segment basic">
		<h2 class="ui icon header">
		  <i class="settings icon"></i>
		  <div class="content">
			PBS Historical Authority Code Generator
			<div class="sub header">Select a map file to begin.</div>
		  </div>
		</h2>
		<div class="ui labels">
			<span class="ui label">
				<i class="info icon"></i> Authority Map file needs to be generated from PBS data. Ask Sam for further information.
			</span>
		</div>
	</div>
	
	
		
	<div class="ui center aligned basic segment container">
		<!-- <div class="ui left icon file input">

			<input type="file" accept=".csv, text/csv" id="MapSelector1" />

		</div> -->
	
		<div class="ui file action input">
		  <input id="MapSelector" type="file" accept=".csv, text/csv">
		  <label for="MapSelector" class="ui blue looping pulsating transition button " id="MapButton">
			 <i class="file icon"></i>
				Select Map File
		  </label>
		</div>

		
		<div class="ui horizontal divider">
		SEARCH
		</div>
		<div class="ui purple labeled icon button disabled" onclick="GenerateDrugNameDiv();" id="NameSearchButton">
		Drug Name
			<i class="add icon"></i>
		</div>
		<div class="ui green labeled icon button disabled" onclick="GenerateATCCodeDiv();" id="ATCSearchButton">
		ATC Code
			<i class="add icon"></i>
		</div>

		
	</div>	

	<!-- <div class="ui segment container basic horizontally fitted DrugContainer">

		<div class="ui segment">
			<h1 class="ui header">Risperidone<div class="sub header">N06asdf</div></h1>
			<h1 class="ui header"><div class="sub header">Restriction IDs</div></h1>
			<div class="ui labels">
			<div class="ui label">
				<i class="project diagram icon"></i>
				
			</div>
		</div>
		<h1 class="ui header"><div class="sub header">Streamlined Authority Codes</div></h1>
		<div class="ui labels">
			<div class="ui label">
				<i class="code icon"></i>
			</div>
		</div>

		</div>

		
	</div> -->

	<div class="ui segment container basic horizontally fitted DrugContainer" id="DrugContainer"></div>

	<div class="ui container basic segment horizontally fitted" id="OutputSection" style="margin-bottom: 1vh;">

		<h3 class="ui top attached header OutputTitle" id="OutputTitle">Save</h3>
		<div class="ui attached segment">
		
			<!-- Save Types -->

			<div class="ui styled fluid accordion">
				<div class="active title">
					<i class="dropdown icon"></i>
					Save Codes
				</div>
				<div class="active content">
					<div class="ui compact wrapping spaced labeled icon buttons OutputButtons" id="OutputButtons">
				
				
						<button class="ui button" type="button" onclick="Output('CSV');"><i class="save icon"></i>Download .csv file</button>
						
						<button class="ui button" type="button" onclick="Output('Plain');"><i class="cog icon"></i>Generate plain text output</button>
						
						<button class="ui button" type="button" onclick="Output('SASDataFrame');"><i class="cog icon"></i>Generate SAS dataframe output</button>
		
						<button class="ui button" type="button" onclick="Output('SASMacro');" title="Item codes only!"><i class="cog icon"></i>Generate SAS macro variable output</button>
						
						<button class="ui button" type="button" onclick="Output('RDataFrame');"><i class="cog icon"></i>Generate R dataframe output</button>
		
					</div>

					<!-- Generation Options -->
					<div class="ui form" id="SaveGenerationOptions">
						
						<div class="field">
							<label>Options:</label>
							<div class="fields">

								<div class="field">
									<div class="ui invisible checkbox">
										<input type="checkbox" checked="checked" saveoption="DRUG_NAME">
										<label class="ui label blue">Restriction Text</label>
									</div>
								</div>
		
								<div class="field">
									<div class="ui invisible checkbox">
										<input type="checkbox" checked="checked" saveoption="DRUG_NAME">
										<label class="ui label blue">Restriction ID</label>
									</div>
								</div>
								
								<div class="field">
									<div class="ui invisible checkbox">
										<input type="checkbox" checked="checked" class="" saveoption="FORM_STRENGTH">
										<label class="ui label blue">Streamlined Authority Code</label>
									</div>
								</div>
		
								
		
							</div>
						</div>
						
		
					</div>

				</div>
				<div class="title">
					<i class="dropdown icon"></i>
					Item-Code combos
				</div>
				<div class="content">

					<div class="ui compact wrapping spaced labeled icon buttons OutputButtons" id="OutputButtons">
				
				
						<button class="ui button" type="button" onclick="Output('CSV');"><i class="save icon"></i>Download .csv file</button>
						
						<button class="ui button" type="button" onclick="Output('Plain');"><i class="cog icon"></i>Generate plain text output</button>
						
						<button class="ui button" type="button" onclick="Output('SASDataFrame');"><i class="cog icon"></i>Generate SAS dataframe output</button>

						<button class="ui button" type="button" onclick="Output('RDataFrame');"><i class="cog icon"></i>Generate R dataframe output</button>
		
					</div>

					<!-- Generation Options -->
					<div class="ui form" id="SaveGenerationOptions">
						
						<div class="field">
							<label>Options:</label>
							<div class="fields">

								<div class="field">
									<div class="ui invisible checkbox">
										<input type="checkbox" checked="checked" saveoption="DRUG_NAME">
										<label class="ui label blue">Drug Name</label>
									</div>
								</div>

								<div class="field">
									<div class="ui invisible checkbox">
										<input type="checkbox" checked="checked" saveoption="DRUG_NAME">
										<label class="ui label blue">ATC</label>
									</div>
								</div>

								<div class="field">
									<div class="ui invisible checkbox">
										<input type="checkbox" checked="checked" saveoption="DRUG_NAME">
										<label class="ui label blue">Restriction Text</label>
									</div>
								</div>
		
								<div class="field">
									<div class="ui invisible checkbox">
										<input type="checkbox" checked="checked" saveoption="DRUG_NAME">
										<label class="ui label blue">Restriction ID</label>
									</div>
								</div>

								<div class="field">
									<div class="ui invisible checkbox">
										<input type="checkbox" checked="checked" saveoption="DRUG_NAME">
										<label class="ui label blue">Last Approved</label>
									</div>
								</div>
								
								<div class="field">
									<div class="ui invisible checkbox">
										<input type="checkbox" checked="checked" class="" saveoption="FORM_STRENGTH">
										<label class="ui label blue">Streamlined Authority Code</label>
									</div>
								</div>

								<div class="field">
									<div class="ui invisible checkbox">
										<input type="checkbox" checked="checked" saveoption="DRUG_NAME">
										<label class="ui label blue">Last Claimed</label>
									</div>
								</div>
		
								
		
							</div>
						</div>
						
		
					</div>
					
				</div>
			</div>
			
			

			
			

			<div class="ui form OutputCode">
				<div class="field">
					<label>Output Code:</label>
					<div class="ui corner labeled input">
					<div class="ui corner label">
						<i class="code icon"></i>
					</div>
					<textarea id="OutputCode"></textarea>
				</div>
				</div>
			</div>

	</div>

	</div>


	<div class="ui container basic segment horizontally fitted" id="OutputSectio" style="display:none; margin-bottom: 1vh;">

		<h3 class="ui top attached header OutputTitle" id="OutputTitle">Save</h3>
		<div class="ui attached segment">
		
			<div class="ui compact wrapping spaced labeled icon buttons OutputButtons" id="OutputButtons">
				
				<button class="ui button" type="button" onclick="OutputCSV();"><i class="save icon"></i>Download .csv file</button>
				
				<button class="ui button" type="button" onclick="OutputPlain();"><i class="cog icon"></i>Generate plain text output</button>
				
				<button class="ui button" type="button" onclick="OutputSASData();"><i class="cog icon"></i>Generate SAS dataframe output</button>
				
				<button class="ui button" type="button" onclick="OutputSASMacroVar();"><i class="cog icon"></i>Generate SAS macro variable output</button>
				
				<button class="ui button" type="button" onclick="OutputR();"><i class="cog icon"></i>Generate R dataframe output</button>

			</div>

			<div class="ui form OutputCode">
				<div class="field">
					<label>Output Code:</label>
					<div class="ui corner labeled input">
					<div class="ui corner label">
						<i class="code icon"></i>
					</div>
					<textarea id="OutputCode"></textarea>
				</div>
				</div>
			</div>

		</div>

	</div>

	<!-- Templates -->

	<template id="RestrictionIDIcon">
		<div class="ui label" onclick="HighlightCodes(this, 'restriction', '.Code', this.parentElement.parentElement.parentElement);">
			<i class="project diagram icon"></i>
			<span class="Code"></span>
		</div>
	</template>

	<template id="StreamlinedCodeIcon">
		<div class="ui label" onclick="HighlightCodes(this, 'authority', '.Code', this.parentElement.parentElement.parentElement);">
			<i class="code icon"></i>
			<span class="Code"></span>
		</div>
	</template>

	<template id="AuthCodeHeader">
		<div class="ui blue segment attached" style="margin-top:1rem !important;">
			<h2 class="ui header drugname"><div class="sub header drugatc"></div></h2>
			<h1 class="ui header"><div class="sub header">Restriction IDs</div></h1>
			<div class="ui labels RestrictionIdsList">
			
			</div>
			<h1 class="ui header"><div class="sub header">Streamlined Authority Codes</div></h1>
			<div class="ui labels StreamlinedCodesList">
				
			</div>

		</div>
	</template>

	<template id="AuthCodeContainer">
		<div class="ui card AuthCodeContainer">
			<div class="content">
				<!-- <i class="ui right floated close icon" style="cursor: pointer;" onclick="this.parentElement.parentElement.remove();"></i> -->
				<button class="ui right floated icon button red mini compact" type="button" onclick="Delete(this, 'Item')"><i class="close icon"></i></button>
				<div class="header ItemCode"></div>
				<div class="meta ItemForm"></div>
			</div>
			<div class="extra content">
					<div class="ui centered container">
					<div class="ui small label RestrictionDate" title="" onclick="HighlightCodes(this, 'restriction', '.RestrictionCode', this.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement);">
						<i class="project diagram icon"></i>
						<span class="RestrictionCode"></span>
					</div>
					
					<div class="ui small label AuthorityDate" title="" onclick="HighlightCodes(this, 'authority', '.AuthorityCode', this.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement);">
						<i class="code icon"></i>
						<span class="AuthorityCode"></span>
					</div>
				</div>

			</div>
		</div>
	</template>

	<template id="RestrictionTextContainer">
		
		<div class="title">
			<i class="dropdown icon"></i>
			<button class="ui right floated icon button red" type="button" onclick="Delete(this, 'Group');"><i class="trash icon"></i></button>
			<p class="AuthorityTitle"></p>
		</div>
		<div class="content">

			<div class="ui five stackable cards centered AuthorityGroup">			
				
			</div>
		</div>

	</template>

	<template id="DrugNameTemplate">
		<div class="ui purple segment">

			<div class="DeleteNode">
				<button class="ui right floated icon button red" type="button" onclick="this.parentElement.parentElement.remove();"><i class="trash icon"></i></button>
			</div>

			<div class="DrugHead">
				<div class="InputContainer">
					<div class="ui action input">
					  <input id="SearchTerm" type="text" placeholder="Search Drug Name..." onkeypress="enterKeyPressed(event, this.parentElement.parentElement.parentElement.parentElement, 'DrugName')">
					  <button class="ui icon button purple" onclick="GenerateAuthorityCodes(this.parentElement.parentElement.parentElement.parentElement, 'DrugName')">
						<i class="search icon"></i>
					  </button>
					</div>
				</div>

			</div>

			<div class="OutputContainer">

			</div>
		</div>
	</template>

	<template id="ATCTemplate">
		<div class="ui green segment">
			<div class="DeleteNode">
				<button class="ui right floated icon button red" type="button" onclick="this.parentElement.parentElement.remove();"><i class="trash icon"></i></button>
			</div>

			<div class="DrugHead">
				<div class="InputContainer">
					<!--<label for="SearchTerm">Search ATC Code: </label>
					<input id="SearchTerm" onkeypress="enterKeyPressed(event, this.parentElement.parentElement.parentElement)" />-->
					<div class="ui action input">
					  <input id="SearchTerm" type="text" placeholder="Search ATC Code..." onkeypress="enterKeyPressed(event, this.parentElement.parentElement.parentElement.parentElement, 'ATC')">
					  <button class="ui icon button green" onclick="GenerateAuthorityCodes(this.parentElement.parentElement.parentElement.parentElement, 'ATC')">
						<i class="search icon"></i>
					  </button>
					</div>
				</div>

			</div>
			<div class="OutputContainer">

			</div>
		</div>
	</template>

	<script>
		$('.ui.accordion')
		.accordion()
		;
	</script>

	<script type="text/javascript" src="src/papaparse.min.js"></script>

	<script>

		let DrugMapJson;

		// Load Map file

		const MapSelector = document.getElementById("MapSelector");
		MapSelector.addEventListener('change', (event) => {
			const files = event.target.files;
			console.log(files);
			LoadMapCSV(files);
			document.getElementById("NameSearchButton").classList.remove("disabled");
			document.getElementById("ATCSearchButton").classList.remove("disabled");
			document.getElementById("MapButton").classList.remove("pulsating");
			document.getElementById("OutputSection").style.display = "revert";
		});

		function LoadMapCSV(FileInput) {
			Papa.parse(FileInput[0], {
				header: true,
				skipEmptyLines: true,
				complete: function(results) {
					console.log(results);
					DrugMapJson = results.data;
				}
			});
		};

		// Clone templates

		function GenerateDrugNameDiv() {
			const DivHolder = document.getElementById("DrugContainer");
			const Template = document.getElementById("DrugNameTemplate");
			const NewDiv = Template.content.cloneNode(true);

			DivHolder.appendChild(NewDiv);

		}

		function GenerateATCCodeDiv() {

			const DivHolder = document.getElementById("DrugContainer");
			const Template = document.getElementById("ATCTemplate");
			const NewDiv = Template.content.cloneNode(true);

			DivHolder.appendChild(NewDiv);

		}

		function GenerateNewInput(NewInputButton) {

			const DrugNode = NewInputButton.parentElement;
			const InputTemplate = document.getElementById("ItemCodeTemplate");
			const InputClone = InputTemplate.content.cloneNode(true);

			DrugNode.insertBefore(InputClone, NewInputButton);

		};

		// Let people hit enter in the search box

		function enterKeyPressed(event, DrugDiv, ContainerType) {
			if (event.keyCode == 13) {
				 if (ContainerType == "DrugName") {
					GenerateAuthorityCodes(DrugDiv, "DrugName");
				 } else if (ContainerType == "ATC") {
					GenerateAuthorityCodes(DrugDiv, "ATC");
				};
			  };
		};

		// Turn on the acorr

		function DoAccordion() {
			$('.ui.accordion')
			.accordion()
			;
		}

		// Toggle the restriction text button

		function ToggleRestrictionText(theButton) {

			theButton.parentElement.classList.toggle('minimised')

			if (theButton.querySelector("p").innerText == "⇨") {
				theButton.querySelector("p").innerText = "⇦";
			} else {
				theButton.querySelector("p").innerText = "⇨";
			};

		};

		function Delete(Element, ContainerType) {
			
			if (ContainerType == "Item") {
				let DrugATCGroup = Element.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement;
				Element.parentElement.parentElement.remove();
				GetUniqueCodes(DrugATCGroup);

			} else if (ContainerType == "Group") {
				let DrugATCGroup = Element.parentElement.parentElement.parentElement;
				Element.parentElement.nextElementSibling.remove(); 
				Element.parentElement.remove();
				GetUniqueCodes(DrugATCGroup);
			};

			
		}

		// Delete the auth code container, and the whole container if empty

		function DeleteAuthCode(AuthCodeContainer) {

			AuthGroup = AuthCodeContainer.parentElement;
			DrugATCGrouping = AuthGroup.parentElement;

			AuthCodeContainer.remove();

			if (AuthGroup.children.length == 0) {
			// remove the title and subtitle
				AuthGroup.previousElementSibling.remove()
				AuthGroup.previousElementSibling.remove();
				AuthGroup.remove();
			};

			if (DrugATCGrouping.children.length == 0) {
			// remove the title, subtitle, and expand button
				DrugATCGrouping.previousElementSibling.remove()
				DrugATCGrouping.previousElementSibling.remove();
				DrugATCGrouping.previousElementSibling.remove();
				DrugATCGrouping.remove();
			};

		};

		function ToggleCodes(ExpandButton) {

			let AuthGroup = ExpandButton.nextElementSibling;
			AuthGroup.classList.toggle("collapsed");

			if (AuthGroup.classList.contains("collapsed")) {

				ExpandButton.innerText = "View Item Codes";

			} else {

				ExpandButton.innerText = "Hide Item Codes";

			};

		};

		function ToggleAllCodes(DrugATCGroup) {

			DrugATCGroup.querySelectorAll(".AuthGroup").forEach((group) => {
				group.classList.toggle("collapsed");
			});


		};

		function GenerateAuthNode(OutputContainer, RestrictionItemDict, FoundDrugNameATC, RestrictionText) {

			const AuthTemplate = document.getElementById("AuthCodeContainer");
			const RestrictionTemplate = document.getElementById("RestrictionTextContainer");

			const DrugNode = RestrictionTemplate.content.cloneNode(true);

			let ReadableRestriction;

			// Create an input for each item code associated with the drug name
			// val is a tuple of [drug name, strength/form]
			RestrictionItemDict[RestrictionText].forEach((drug) => {
				const AuthClone = AuthTemplate.content.cloneNode(true);

				AuthClone.querySelector(".ItemForm").innerText = drug.FORM_STRENGTH;
				AuthClone.querySelector(".ItemCode").innerText = drug.ITEM_CODE;

				AuthClone.querySelector(".RestrictionCode").innerText = drug.RSTR_NUM;
				AuthClone.querySelector(".RestrictionDate").title = "Last Approved: " +  drug.LAST_APPR_DATE;

				if (!(drug.RSTR_NUM)) {		
					AuthClone.querySelector(".RestrictionDate").remove();
				};

				AuthClone.querySelector(".AuthorityCode").innerText = drug.STREAMLINE_AUTHORITY_CODE;
				AuthClone.querySelector(".AuthorityDate").title = "Last Claimed: " + drug.LAST_CLAIM_DATE;

				if (!(drug.STREAMLINE_AUTHORITY_CODE)) {
					AuthClone.querySelector(".AuthorityDate").remove();
				};

				DrugNode.querySelector(".AuthorityGroup").appendChild(AuthClone);
				ReadableRestriction = drug.Restriction_Text;
			});

			let RestrictionTextFixed = ReadableRestriction.replace("Clinical criteria:", "<br><br>Clinical criteria:");
			RestrictionTextFixed = RestrictionTextFixed.replace("Treatment Phase:", "<br><br>Treatment Phase:");
			RestrictionTextFixed = RestrictionTextFixed.replace("Population criteria:", "<br><br>Population criteria:");
			RestrictionTextFixed = RestrictionTextFixed.replace("Treatment criteria:", "<br><br>Treatment criteria:");
			RestrictionTextFixed = RestrictionTextFixed.replaceAll("*", "<br><br>‣");
			RestrictionTextFixed = RestrictionTextFixed.replaceAll("\x22", "");
			const node = document.createTextNode(RestrictionTextFixed);
	

			DrugNode.querySelector(".AuthorityTitle").innerHTML = RestrictionTextFixed;

		   OutputContainer.appendChild(DrugNode);

		};

		function HighlightCodes(Code, CodeType, TextLoc, DrugATCGroup) {
			//CodesContainer = Code.parentElement;
			//DrugATCGroup = Code.parentElement.parentElement.nextElementSibling;
			CurrentCode = Code.querySelector(TextLoc).innerText;

			if (CodeType == "restriction") {

				// Remove any existing color from the elements
				DrugATCGroup.querySelectorAll(".RestrictionIdsList .label").forEach((label) => {
					label.classList.remove("blue");
					if (label.querySelector(".Code")) {
					if (label.querySelector(".Code").innerText == CurrentCode) {
							label.classList.add("blue");
						};
					};
				})

				DrugATCGroup.querySelectorAll(".RestrictionDate").forEach((label) => {
					label.classList.remove("blue");
					if (label.querySelector(".RestrictionCode")) {
					if (label.querySelector(".RestrictionCode").innerText == CurrentCode) {
						label.classList.add("blue");
					};
				};
				});

			} else if (CodeType == "authority") {

				DrugATCGroup.querySelectorAll(".StreamlinedCodesList .label").forEach((label) => {
					label.classList.remove("blue");
					if (label.querySelector(".Code")) {
						if (label.querySelector(".Code").innerText == CurrentCode) {
							label.classList.add("blue");
						};
					};
				});

				DrugATCGroup.querySelectorAll(".AuthorityDate").forEach((label) => {
					label.classList.remove("blue");
					if (label.querySelector(".AuthorityCode")) {
						if (label.querySelector(".AuthorityCode").innerText == CurrentCode) {
							label.classList.add("blue");
						};
					};
				});

			}

			

	
		}

		function GetUniqueCodes(DrugATCGroup) {

			DrugATCGroup.querySelector(".RestrictionIdsList").replaceChildren();
			DrugATCGroup.querySelector(".StreamlinedCodesList").replaceChildren();

			UnqRestrictionIds = new Set();
			UnqAuthCodes = new Set();
			// Gets the unique codes - sets can only contain unique items
			DrugATCGroup.querySelectorAll(".AuthCodeContainer").forEach((container) => {
				if (container.querySelector(".RestrictionCode")) {UnqRestrictionIds.add(container.querySelector(".RestrictionCode").innerText);};
				if (container.querySelector(".AuthorityCode")) {UnqAuthCodes.add(container.querySelector(".AuthorityCode").innerText);};
			});

			// Turns them into an array, sorts them
			SortRestrictionIds = Array.from(UnqRestrictionIds);
			SortRestrictionIds.sort();

			SortAuthCodes = Array.from(UnqAuthCodes);
			SortAuthCodes.sort();

			SortRestrictionIds.forEach((RstrID) => {
				const RestrictionIcon = document.getElementById("RestrictionIDIcon").content.cloneNode(true);
				RestrictionIcon.querySelector(".Code").innerText = RstrID;
				DrugATCGroup.querySelector(".RestrictionIdsList").appendChild(RestrictionIcon);
			});

			SortAuthCodes.forEach((StreamlinedCode) => {
				const StreamlinedCodeIcon = document.getElementById("StreamlinedCodeIcon").content.cloneNode(true);
				StreamlinedCodeIcon.querySelector(".Code").innerText = StreamlinedCode;
				DrugATCGroup.querySelector(".StreamlinedCodesList").appendChild(StreamlinedCodeIcon);
			});

			//console.log(UnqRestrictionIds);
			//console.log(UnqAuthCodes);
		};

		function GenerateAuthorityCodes(DrugDiv, SearchType="DrugName") {

			Search = DrugDiv.querySelector("#SearchTerm").value.toUpperCase();

			let OutputContainer = DrugDiv.querySelector(".OutputContainer");
			const DrugHead = DrugDiv.querySelector(".DrugHead");

			let FoundItemsDict = {};

			let FoundItemList = [];
			let FoundIndicationsList = [];


			if (Search) {

				// Reads drugs that match the keyword into a dictionary.
				for (const Drug of DrugMapJson) {

					if (((SearchType == "DrugName" && Drug.DRUG_NAME.includes(Search)) || (SearchType == "ATC" && Drug.ATC5_Code.substring(0, Search.length).includes(Search))) && (Drug.STREAMLINE_AUTHORITY_CODE || Drug.Restriction_Text || Drug.RSTR_NUM)) {

						let DrugNameATC = Drug.DRUG_NAME + "|" + Drug.ATC5_Code;

						if (DrugNameATC in FoundItemsDict) {
						  FoundItemsDict[DrugNameATC].push(Drug);
						} else {
						  FoundItemsDict[DrugNameATC] = [Drug];
						};

					};

				};

				const SearchTitle = document.createElement("p");
					SearchTitle.classList.add("DrugTitle");
					if (SearchType == "DrugName") {
					SearchTitle.innerText = "Name: ''" + Search + "'' // " + Object.keys(FoundItemsDict).length + " results";
				} else if (SearchType == "ATC") {;
					SearchTitle.innerText = "ATC: " + Search + " // " + Object.keys(FoundItemsDict).length + " results";
				};

				OutputContainer.appendChild(SearchTitle);

				for (const FoundItem in FoundItemsDict) {

					let DrugName = FoundItem.split("|")[0];
					let DrugATC = FoundItem.split("|")[1];

					let FoundRestrictionsDict = {};

					// Group the indications for the current drug into a dictionary

					FoundItemsDict[FoundItem].forEach((Drug) => {
						//let IndicationPhase = Drug.Indication + "|" + Drug.treatment_phase;

						let RestrictionText = Drug.Restriction_Text.replaceAll(" ", "");

						if (!(Drug.Restriction_Text)) {Drug.Restriction_Text = "-Invalid Code-"};

						if (RestrictionText in FoundRestrictionsDict) {
						  FoundRestrictionsDict[RestrictionText].push(Drug);
						} else {
						  FoundRestrictionsDict[RestrictionText] = [Drug];
						};

					});

					// const Title = document.createElement("p");
					// Title.classList.add("DrugTitle");
					// const node = document.createTextNode(DrugName + " // " + Object.keys(FoundRestrictionsDict).length);
					// Title.appendChild(node);
					// OutputContainer.appendChild(Title);

					// const SubTitle = document.createElement("p");
					// SubTitle.classList.add("DrugSubTitle");
					// const node2 = document.createTextNode(DrugATC);
					// SubTitle.appendChild(node2);
					// OutputContainer.appendChild(SubTitle);


					const DrugATCGroup = document.createElement("div");

					DrugATCGroup.setAttribute("DrugName", DrugName);
					DrugATCGroup.setAttribute("DrugATC", DrugATC);

					const DrugATCRestrictions = document.createElement("div");
					DrugATCRestrictions.classList.add("DrugATCGrouping", "ui", "styled", "fluid", "accordion");

					const GroupHead = document.getElementById("AuthCodeHeader").content.cloneNode(true);
					console.log(GroupHead);
					GroupHead.querySelector(".drugname").textContent = DrugName + " // " + Object.keys(FoundRestrictionsDict).length;
					let ATCSubtitle = document.createElement("div");
					ATCSubtitle.classList.add("sub", "header");
					ATCSubtitle.innerText = DrugATC;
					
					//GroupHead.querySelector(".drugatc").innerText = DrugATC;
					GroupHead.querySelector(".drugname").appendChild(ATCSubtitle);
					

					//const ExpandAllClone = document.getElementById("HideAllCodesTemplate").content.cloneNode(true);
					//OutputContainer.appendChild(ExpandAllClone);

					for (const Restriction in FoundRestrictionsDict) {
						GenerateAuthNode(DrugATCRestrictions, FoundRestrictionsDict, FoundItem, Restriction);
					}

					// Get the unique Auth Codes and Restriction Ids
					
					

					DrugATCGroup.appendChild(GroupHead);
					DrugATCGroup.appendChild(DrugATCRestrictions);

					GetUniqueCodes(DrugATCGroup);

					OutputContainer.appendChild(DrugATCGroup);

				};

				//Check if there wasn't a result

				if (Object.keys(FoundItemsDict).length == 0) {
					const ErrorMsg = document.createElement("p");
					ErrorMsg.classList.add("ErrorMsg");
					const ErrorText = document.createTextNode("Error! Either the search term was misspelled, or there weren't any authority codes associated with this search!");
					ErrorMsg.appendChild(ErrorText);
					OutputContainer.appendChild(ErrorMsg);
				}

				// Hide the search input
				DrugHead.style.display = "none";
				DoAccordion();

			}

		};

		// Create outputs

		function OutputCSV() {

			const AuthGroups = document.querySelectorAll(".AuthGroup");
			let OutputArray = [];

			AuthGroups.forEach((Node) => {

				const ItemCodes = Node.querySelectorAll(".AuthCodeContainer");
				//let Indication = Node.getAttribute("indication");
				//let TreatmentPhase = Node.getAttribute("treatmentphase");
				let RestrictionText = Node.previousElementSibling.previousElementSibling.innerText;

				// Construct an object for each item code in the node, push into the output array
				ItemCodes.forEach((Item) => {
					const DrugObj = {};

					DrugObj.ITEM_CODE = Item.querySelector(".code").innerText;
					DrugObj.DRUG_NAME = Item.querySelector(".name").innerText.split(" | ")[0];
					DrugObj["FORM/STRENGTH"] = Item.querySelector(".name").innerText.split(" | ")[1];
					//DrugObj.AUTHORITY_METHOD = Item.querySelector(".authmethod").innerText;

					if (Item.querySelector(".restrictioncode")) {
						DrugObj.RESTRICTION_ID = Item.querySelector(".restrictioncode").value;
						DrugObj.LAST_APPROVED_DATE = Item.querySelector(".restrictiondate").innerText.replace("Last Approved: ", "");
					};

					if (Item.querySelector(".authcode")) {
						DrugObj.AUTHORITY_CODE = Item.querySelector(".authcode").value;
						DrugObj.LAST_CLAIMED_DATE = Item.querySelector(".authoritydate").innerText.replace("Last Claimed: ", "");
					};

					DrugObj.RESTRICTION_TEXT = RestrictionText;


					OutputArray.push(DrugObj);
				});

			});

			// Turn the array of objects into a csv string
			let OutputCSV = Papa.unparse(OutputArray);

			console.log(OutputCSV);

			// Encode the string as a URI, open to make the file save.
			let encodedUri = encodeURI("data:text/csv;charset=utf-8," + OutputCSV);
			window.open(encodedUri);

		};

		function OutputSAS() {

			const AuthGroups = document.querySelectorAll(".AuthGroup");
			const CodeOutput = document.getElementById("OutputCode");
			// Unhide the code output div.
			CodeOutput.parentElement.style.display = "flex";

			// Reset the output container, set it to the start of a data statement
			CodeOutput.value = "data AuthCodes;\n";
			CodeOutput.value += "	infile datalines delimiter=',';\n";
			//CodeOutput.value += "	input Item_Code $ Drug_Name $ Authority_Method $ Authority_Code $ Indication $ Treatment_Phase $ ;\n";
			CodeOutput.value += "	input Drug_Name :$50. Item_Code :$6. Restriction_ID :$10. Authority_Code :$10. ;\n";
			CodeOutput.value += "	datalines;";

			let AuthFlag = false;
			let RstrFlag = false;

			AuthGroups.forEach((Node) => {

				const ItemCodes = Node.querySelectorAll(".AuthCodeContainer");


				//CodeOutput.value += "\n\n/* " + Indication + " - " + TreatmentPhase + " */\n";

				// Construct an object for each item code in the node, push into the output array
				ItemCodes.forEach((Item) => {
					let Line = Item.querySelector(".name").innerText.split(" | ")[0];
					Line += "," + Item.querySelector(".code").innerText;
					//Line += "," + Item.querySelector(".authmethod").innerText;
					if (Item.querySelector(".restrictioncode")) {
						Line += "," + Item.querySelector(".restrictioncode").value;
						RstrFlag = true;
					};
					if (Item.querySelector(".authcode")) {
						Line += "," + Item.querySelector(".authcode").value;
						AuthFlag = true;
					};
					//Line += "," + Indication;
					//Line += "," + TreatmentPhase.replace(",", "");

					CodeOutput.value += "\n" + Line;
				});

			});

			if (!AuthFlag) {
				CodeOutput.value = CodeOutput.value.replace(" Authority_Code :$10.", "")
			};

			if (!RstrFlag) {
				CodeOutput.value = CodeOutput.value.replace(" Restriction_ID :$10.", "")
			};

			CodeOutput.value += "\n;\n\n";

			// End the data node
			CodeOutput.value += "run;\n";

		};

		function OutputR() {

			const AuthGroups = document.querySelectorAll(".AuthGroup");
			const CodeOutput = document.getElementById("OutputCode");
			// Unhide the code output div.
			CodeOutput.parentElement.style.display = "flex";

			// Reset the output container, set it to the start of a data statement
			CodeOutput.value = "AuthCodes <- data.frame(";

			let OutputList = [];

			AuthGroups.forEach((Node) => {

				const ItemCodes = Node.querySelectorAll(".AuthCodeContainer");

				// Construct an object for each item code in the node, push into the output array
				ItemCodes.forEach((Item) => {
					let DrugName = Item.querySelector(".name").innerText.split(" | ")[0];
					let ItemCode = Item.querySelector(".code").innerText;
					let RestrictionID = Item.querySelector(".restrictioncode").value;
					let AuthCode = Item.querySelector(".authcode").value;
					OutputList.push([DrugName, ItemCode, RestrictionID, AuthCode]);
				});

			});

			CodeOutput.value += "Drug_Name=c(";

			OutputList.forEach((Drug, i) => {
				if (i != 0) {CodeOutput.value += ", "};
				CodeOutput.value += "'" + Drug[0] + "'";
			});

			CodeOutput.value += "),\nItem_Code=c(";

			OutputList.forEach((Drug, i) => {
				if (i != 0) {CodeOutput.value += ", "};
				CodeOutput.value += "'" + Drug[1] + "'";
			});

			CodeOutput.value += "),\nRestriction_ID=c(";

			OutputList.forEach((Drug, i) => {
				if (i != 0) {CodeOutput.value += ", "};
				CodeOutput.value += "'" + Drug[2] + "'";
			});

			CodeOutput.value += "),\nAuth_Code=c(";

			OutputList.forEach((Drug, i) => {
				if (i != 0) {CodeOutput.value += ", "};
				CodeOutput.value += "'" + Drug[3] + "'";
			});

			CodeOutput.value += "))";

		};

	</script>

</body>
</html>
